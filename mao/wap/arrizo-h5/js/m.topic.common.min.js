var Comment_Enum_Channel={ALL:0,NEWS:1,CAR:2,BBS:3},Comment_Enum_ObjType={ALL:0,NEWS:1,NEWS_TOPIC:14,NEWS_SALON:15,CAR_BRAND_NEWS:2,CAR_BRAND_PHOTO:3,CAR_BRAND_ACTIVITY:4,CAR_SERIE_REVIEW:13,CAR_AUTO:6,CAR_SELECT_TOPIC:5,CAR_PRAISE:7,BBS_FOOTMARK:8,BBS_FURTHER_ASK:9,BBS_RAIDERS:10,BBS_ARENA:11,BBS_GROUP:12};!function(a,b){b._comment=function(a){this._init(a)},b._comment.prototype={_init:function(a){this._url="http://www.emao.com/index.php?r=comment/commentopt/",this._channel=a.channel||0,this._obj_type=a.obj_type||0,this._obj_id=a.obj_id||0,this._per_page=a.per_page||5,this._least_word=a.least_word||5,this._more_mode=a.more_mode||"falls",this._comment_callback=a.comment_callback||this._comment_str,this._add_comment_callback=a.add_comment_callback||this._add_comment_str,this._reply_comment_callback=a.reply_comment_callback||this._reply_str,this._user_id=0,this._user_info={},this._cur_page=1,this._author_id=a.author_id||0,this._comment_max_length=a.comment_max_length||300,this._page(),this._add_comment(),this._reply(),this._support(),this._del(),this._falls_comment(),this._init_interface()},_set_userinfo:function(a){this._user_id=a.id||0,this._user_info=a},_ajax:function(a,c,d,e){b.ajax({data:c,url:a,dataType:"jsonp",success:d,error:e||function(){}})},_get_comment:function(a){var c=this,a=a||this._cur_page,d=function(a){var d=a;c._set_userinfo(d.user_info),"falls"==c._more_mode?(b("#comments").append(c._make_comments(d.comments)),c._cur_page++):b("#comments").html(c._make_comments(d.comments));var e="page"==c._more_mode?d.pages_html:d.comments.length<c._per_page?'<a class="see-more" href="javascript:;">\u6ca1\u6709\u66f4\u591a\u8bc4\u8bba\u4e86...</a>':'<a id="more_comment" class="see-more" href="javascript:;">\u52a0\u8f7d\u66f4\u591a<i class="d-gt"></i></a>';b("#pages").html(e),b("#publish_comment").html(c._publish_html()),c._emotions()};this._ajax(c._url+"commentajax",{cur_page:a,per_page:c._per_page,obj_id:c._obj_id,channel:c._channel,obj_type:c._obj_type},d)},_make_comments:function(a){var c="",d="\u4e00\u732b\u8f66\u53cb",e="http://s.emao.net/images/common/uc_user_avatar.png";for(var f in a)b("#comment_"+a[f].id).remove(),c+='<li id="comment_'+a[f].id+'">',c+='<div class="pic fl">',c+='<a href="http://i.m.emao.com/'+a[f].userId+'/main/" target="_blank" ><img src="'+(a[f].user_info.header_img_url||e)+'"/></a>',c+="</div>",c+='<div class="user-con">',c+='<a href="http://i.m.emao.com/'+a[f].userId+'/main/" target="_blank">'+(a[f].user_info.nickname||d)+"</a>",c+="<p>"+(a[f].replyUserId>0?'\u56de\u590d<span class="name"><a href="http://i.m.emao.com/'+a[f].replyUserId+'/main/" target="_blank">@'+(a[f].reply_user_info.nickname||d)+"</a></span>:":"")+this._comment_callback(a[f].content)+"</p>",c+='<div class="flag">',c+='<span class="time">'+a[f].addTime+"</span>",c+='<a href="javascript:;" class="praise"'+("1"==a[f].supported?"":' id="support_'+a[f].id+'"')+'><i></i><em><lable id="support_num_'+a[f].id+'">'+(a[f].supportNum>0?"\u70b9\u8d5e("+a[f].supportNum+")":"\u70b9\u8d5e")+"</label></em></a>",c+=""+((a[f].user_info.id||"")===this._user_id?'<span class="line">|</span><a href="javascript:void(0);" id="del_comment_'+a[f].id+'" class="ss">\u5220\u9664</a>':""),c+="</div>",c+="</div>",c+="</li>";return c},_page:function(){var a=this;b(document).on("click","#pages a",function(){var c=b(this).attr("href");return isNaN(c)||a._get_comment(c),!1})},_add_comment:function(){var a=this;b(document).on("click","#add_comment",function(){var c=this;if(!b(c).hasClass("_unuse")){var d=b("#comment_text_publish"),e=a._add_comment_callback(d.val());if(d.val(e),a._check_word_length(d),!(e.length<a._least_word)){var f=function(e){a._hide_msg("com-mod");var f=e;0==f.code?(b("#comments").prepend(a._make_comments(f.data)),a._text_reset(d),b("body, html").animate({scrollTop:b("#comments").offset().top-50})):a._hide_msg("com-mod"),b(c).removeClass("_unuse")},g=function(){a._hide_msg("com-mod"),b(c).removeClass("_unuse")},h={comment:e,obj_id:a._obj_id,channel:a._channel,obj_type:a._obj_type,author_id:a._author_id};a._ajax(a._url+"addcomment",h,f,g)}}})},_reply:function(){var a=this;b(document).on("click","[id^=reply_]",function(){if(!b(this).hasClass("btns")){var c=this.id.split("_")[1],d=a._reply_comment_callback(b("#comment_text_"+c).val());if(b("#comment_text_"+c).val(d),d.length<a._least_word)return void a._show_msg("comment_text_"+c,!1);var e=function(d){a._hide_msg("comment_"+c);var e=d;0==e.code?(b("#comments").prepend(a._make_comments(e.data)),b("#comment_text_"+c).val("").keyup(),a._emotions(),b("#comment_"+c+" .reply").click(),b("body, html").animate({scrollTop:b("#comments").offset().top-50})):a._hide_msg("comment_"+c)},f=function(){a._hide_msg("comment_"+c)};a._ajax(a._url+"replycomment",{comment:d,obj_id:c,channel:a._channel,obj_type:a._obj_type,author_id:a._author_id,article_id:a._obj_id},e,f)}})},_support:function(){var c=this;b(document).on("click","a[id^=support_]",function(){var d=this,e=this.id.split("_")[1];if(e){if(c._user_id<1)return void(a.location.href="http://i.m.emao.com/login/");var f=function(c){var f=c;if(0==f.code){var g=isNaN(1*b("#support_num_"+e).text())?1:1*b("#support_num_"+e).text()+1;b("#support_num_"+e).text("\u70b9\u8d5e("+g+")"),b(d).find("i").addClass("cur"),b('<span class="funcs-score">+1</span>').css({position:"absolute",left:"20px",top:"-5px",color:"javascript:;f39d26"}).appendTo(b(d).find("i").parent()),b(".com-handle").find(".funcs-score").animate({top:"-30px",opacity:1},500,function(){b(this).remove()}),b(d).removeAttr("id")}else if(-2==f.code)return void(a.location.href="http://i.m.emao.com/login/")};c._ajax(c._url+"supportcomment",{obj_id:e,channel:c._channel,obj_type:c._obj_type},f)}})},_del:function(){var a=this;b(document).on("click","a[id^=del_comment_]",function(){var c=this.id.split("_")[2];if(c){var d=confirm("\u786e\u5b9a\u8981\u5220\u9664\u8be5\u8bc4\u5185\u5bb9\u5417\uff1f");if(d){var e=function(a){var d=a;0==d.code&&b("#comment_"+c).remove()};a._ajax(a._url+"delcomment",{obj_id:c,channel:a._channel,obj_type:a._obj_type},e)}}})},_publish_html:function(){var a=this._user_info.nickname||"\u4e00\u732b\u8f66\u53cb",b=this._user_id>0?this._user_info.header_img_url:"http://s.emao.net/images/common/uc_user_avatar.png",c="";return c+='<div class="user-news" id="commentAnchor" name="#commentAnchor">',c+='<span><em id="publish_msg"></em><em id="publish_length">0</em>/'+this._comment_max_length+"</span>",c+='<a href="javascript:;"><img src="'+b+'"></a>',c+='<a href="javascript:;">'+a+"</a>",c+='<div class="reply-box"'+(this._user_id<1?' style="display:none;"':"")+">",c+='<textarea name="" rows="" cols="" placeholder="\u5185\u5bb9..." id="comment_text_publish" length_for="publish_length" msg_for="publish_msg"></textarea>',c+="</div>",c+='<div class="reply-box"'+(this._user_id>0?' style="display:none;"':"")+">",c+='<div class="login">',c+='<p>\u8bf7<a href="http://i.m.emao.com/?act=login">\u767b\u5f55</a>\u540e\u624d\u53ef\u4ee5\u53d1\u8868\u8bc4\u8bba\uff0c\u6216<a href="http://i.m.emao.com/?act=register">\u5feb\u901f\u6ce8\u518c</a></p>',c+="</div>",c+="</div>",c+='<div class="btn-wrap">',c+='<a class="btn green'+(this._user_id>0?"":" _unuse")+'" href="javascript:;" id="add_comment">\u53d1\u8868\u8bc4\u8bba</a>',c+="</div>",c+="</div>"},_falls_comment:function(){var a=this;b(document).on("click","#more_comment",function(){a._get_comment(this._cur_page)})},_comment_str:function(a){try{return b.emotion.strToEmotions(a.trim())}catch(c){return a.trim()}},_add_comment_str:function(a){return a.trim()},_reply_str:function(a){return a.trim()},_init_interface:function(){var a=this;a._user_id>0&&(b(".login").hide(),b(".com-box").show(),b(".share-box").show(),b(".num").show(),b(".btn-primary").removeClass("btns")),b(".com-btn button").hasClass("btns")?b(".com-btn button").attr("disabled","disabled"):b(".com-btn button").attr("disabled",!1),b(document).on("click",".reply",function(){a._user_id>0&&(b(".login").hide(),b(".com-box").show(),b(".share-box").show(),b(".num").show(),b(".btn-primary").removeClass("btns"));var c=b(this).find("a").text();"\u56de\u590d"==c?(b(this).find("a").text("\u6536\u8d77").parents("dl").siblings().find(".reply a").text("\u56de\u590d"),b(this).parents("dl").find(".gd").show().siblings().parents("dl").siblings().find(".gd").hide()):(b(this).parents("dl").find(".gd").hide(),b(this).find("a").text("\u56de\u590d"))}),b(document).on("change","textarea[id^=comment_text_]",function(){a._check_word_length(this)})},_check_word_length:function(a){b(a).val(b(a).val().substring(0,this._comment_max_length));var c=b(a).val().length,d=b(a).attr("length_for"),e=b(a).attr("msg_for");c<=this._comment_max_length?b("#"+d).text(c):a.value=a.value.substring(0,this._comment_max_length),0==c?(b("#"+e).css("color","red").text("\u8bf7\u8f93\u5165\u5185\u5bb9...\u3000"),setTimeout('$("#'+e+'").text("")',1e3)):c<this._least_word?(b("#"+e).css("color","red").text("\u5185\u5bb9\u6700\u5c11\u4e3a"+this._least_word+"\u4e2a\u5b57\u3000"),setTimeout('$("#'+e+'").text("")',1e3)):b("#"+e).css("color","red").text("")},_text_reset:function(a){b(a).val("");var c=b(a).attr("length_for"),d=b(a).attr("msg_for");b("#"+c).text(0),b("#"+d).text("")},_check_word:function(a){var c=a.value.length,d=b(a).parents("dd").find(".btn-wrap em");c<=this._comment_max_length?(d.text(c),c>=this._comment_max_length&&b(a).parents("dd").css({color:"#fb7d54"})):a.value=a.value.substring(0,this._comment_max_length)},_show_msg:function(a,c){var d=b("#"+a).width(),e=b("#"+a).parent();return e.find(".login,.login p").css({width:d+"px"}),c?(e.find(".login").css({display:"block",position:"absolute",opacity:"0.5","z-index":"99",border:"none",background:"#fff"}),e.find(".login p").html('<img src="http://s.emao.net/images/news/load_icon.jpg">\u6b63\u5728\u53d1\u8868\u56de\u590d...').addClass("load").removeClass("cols"),!0):(e.find(".login").css({display:"block",position:"absolute","z-index":"99",border:"1px solid #fb7d54",background:"#ffeeea"}),e.find(".login p").html("\u8bc4\u8bba\u4e0d\u80fd\u4f4e\u4e8e"+this._least_word+"\u4e2a\u4e2d\u6587\u5b57\u7b26").addClass("cols").removeClass("load"),setTimeout(function(){e.find(".login").css({display:"none"})},2e3),!1)},_hide_msg:function(a){b("."+a+" .login").hide(),b("."+a+" .com-box").val(""),b("."+a+" .num em").text("0")},_emotions:function(){b("div[id*='commentEmDiv_']").each(function(){var a=b(this).attr("id").replace(/[^0-9]/gi,"");b("#commentEmDiv_"+a).jqfaceedit({txtAreaObj:b("#comment_text_"+a),containerObj:b("#commentEmDiv2_"+a),textareaid:"comment_text_"+a,top:25,left:-27})})}}}(window,Zepto),function(a,b){var c=!1,d="";b(".topic-tp").find("h2 em").tap(function(){setTimeout(function(){b(".reply-box").find("textarea").focus()},1),b(".reply-box").find("textarea").val(""),c=!1,d="",b(".reply-box, .reply-box textarea").addClass("focus")}),b(".user-bd").find(".reply").tap(function(){setTimeout(function(){b(".reply-box").find("textarea").focus()},1),c=!0,d="\u56de\u590d@"+b(this).parents("li").find(".username").text()+":",b(".reply-box").find("textarea").addClass("focus").val(d),b(".reply-box").addClass("focus")}),b(".user-bd").find(".del").on("tap",function(){confirm("\u786e\u5b9a\u8981\u5220\u9664\u5417\uff1f")&&b(this).parents("li").remove()}),b(".user-bd").find(".praise").on("tap",function(){b(this).hasClass("praised")||(b(this).find("em").text("\u70b9\u8d5e"==b(this).find("em").text()?1:Number(b(this).find("em").text())+1),b(this).addClass("praised"))}),b(".reply-box").find("textarea").on("keyup",function(){var a=b(this).val().length;if(c){var e=d.length,f=a-e>300?300:a-e;f=f<0?0:f;var g=b(this).val().replace(d,"").substring(0,f);b(this).val(d+g),b(".user-news").find("span em").text(f),0==f?b(".btn-wrap").find(".btn").addClass("disabled"):b(".btn-wrap").find(".btn").removeClass("disabled")}else a=a>300?300:a,b(this).val(b(this).val().substring(0,a)),b(".user-news").find("span em").text(a),0==a?b(".btn-wrap").find(".btn").addClass("disabled"):b(".btn-wrap").find(".btn").removeClass("disabled")}),b(".btn-wrap .btn").on("tap",function(){-1==this.className.indexOf("disabled")&&(c=!1,d="",b(".reply-box").find("textarea").val(""),b(".user-news").find("span em").text(0),b(".reply-box, .reply-box textarea").removeClass("focus"),b(this).addClass("disabled"))})}(window,Zepto),function(a){a.extend(a.fn,{cookie:function(b,c,d){var e,f,g,h;return arguments.length>1&&"[object Object]"!==String(c)?(d=a.extend({},d),(null===c||void 0===c)&&(d.expires=-1),"number"==typeof d.expires&&(e=24*d.expires*60*60*1e3,f=d.expires=new Date,f.setTime(f.getTime()+e)),c=String(c),document.cookie=[encodeURIComponent(b),"=",d.raw?c:encodeURIComponent(c),d.expires?"; expires="+d.expires.toUTCString():"",d.path?"; path="+d.path:"",d.domain?"; domain="+d.domain:"",d.secure?"; secure":""].join("")):(d=c||{},h=d.raw?function(a){return a}:decodeURIComponent,(g=new RegExp("(?:^|; )"+encodeURIComponent(b)+"=([^;]*)").exec(document.cookie))?h(g[1]):null)}})}(Zepto);